<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모둠 점수판</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&display=swap');

        :root {
            --border-width: 4px;
            --shadow-offset: 6px;
            --bg-color: #ffeaa7;
            --card-c1: #fab1a0;
            --card-c2: #81ecec;
            --card-c3: #74b9ff;
            --card-c4: #a29bfe;
            --card-c5: #55efc4;
            --text-color: #2d3436;

            /* Dynamic settings */
            --group-name-size: 3vw;
            --score-size: 20vh;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Do Hyeon', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            overflow: hidden;
            user-select: none;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            width: 100%;
            height: 100%;
            max-width: 100%;
        }

        /* 5번째 카드는 가운데 정렬 */
        .card:nth-child(5) {
            grid-column: 2 / 3;
        }

        .card {
            background: white;
            border: var(--border-width) solid black;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px black;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .card.active {
            transform: translate(4px, 4px);
            box-shadow: 2px 2px 0px 0px black;
            background-color: #ffff00 !important;
        }

        .card:nth-child(1) {
            background-color: var(--card-c1);
        }

        .card:nth-child(2) {
            background-color: var(--card-c2);
        }

        .card:nth-child(3) {
            background-color: var(--card-c3);
        }

        .card:nth-child(4) {
            background-color: var(--card-c4);
        }

        .card:nth-child(5) {
            background-color: var(--card-c5);
        }

        .group-name {
            font-size: var(--group-name-size);
            margin-bottom: 2vh;
            background: black;
            color: white;
            padding: 0.5rem 2rem;
            transform: skew(-5deg);
            white-space: nowrap;
        }

        .score {
            font-family: 'Black Han Sans', sans-serif;
            font-weight: bold;
            margin: 0;
            line-height: 1;
            font-size: var(--score-size);
        }

        /* Pop animation */
        .pop {
            animation: pop-anim 0.2s ease-in-out;
        }

        @keyframes pop-anim {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Settings Trigger Zone */
        #settings-trigger {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 80px;
            height: 80px;
            z-index: 9999;
            /* background: rgba(255, 0, 0, 0.2); Debug viz */
            cursor: pointer;
        }

        /* Settings Modal */
        #settings-modal {
            display: none;
            /* hidden by default */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            background: white;
            border: 4px solid black;
            box-shadow: 10px 10px 0px black;
            padding: 30px;
            z-index: 10000;
            font-family: 'Do Hyeon', sans-serif;
            max-height: 90vh;
            overflow-y: auto;
        }

        #settings-modal h2 {
            margin-top: 0;
            font-size: 2rem;
            border-bottom: 4px solid black;
            padding-bottom: 10px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .setting-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 3px solid black;
            font-size: 1.2rem;
            font-family: 'Do Hyeon', sans-serif;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
        }

        .setting-group input[type="range"] {
            width: 100%;
            height: 15px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            -webkit-appearance: none;
            appearance: none;
            border: 2px solid black;
        }

        .setting-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: black;
            cursor: pointer;
            border: 2px solid white;
        }

        .name-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .name-input-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .name-input-item span {
            width: 30px;
            font-weight: bold;
        }

        .close-btn {
            display: block;
            width: 100%;
            background: #ff7675;
            color: black;
            border: 3px solid black;
            padding: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 5px 5px 0px black;
            margin-top: 20px;
        }

        .close-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px black;
        }

        .backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }
    </style>
</head>

<body>

    <div class="container" id="grid">
        <!-- Rendered by JS -->
    </div>

    <!-- Hidden Settings Trigger -->
    <div id="settings-trigger" title="Triple click for settings"></div>

    <!-- Settings Modal -->
    <div class="backdrop" id="backdrop"></div>
    <div id="settings-modal">
        <h2>설정 (Settings)</h2>

        <div class="setting-group">
            <label>모둠 이름 글자 크기</label>
            <input type="range" id="size-name" min="1" max="10" step="0.1" value="3">
        </div>

        <div class="setting-group">
            <label>점수 글자 크기</label>
            <input type="range" id="size-score" min="5" max="40" step="1" value="20">
        </div>

        <div class="setting-group">
            <label>모둠 이름 설정</label>
            <div class="name-inputs" id="name-inputs">
                <!-- Inputs generated by JS -->
            </div>
        </div>

        <button class="close-btn" id="close-settings">닫기 (저장)</button>
    </div>

    <script>
        // Config variables
        const GROUPS = 5;
        const INITIAL_SCORE = 0;

        const DEFAULT_SETTINGS = {
            groupNames: ["1모둠", "2모둠", "3모둠", "4모둠", "5모둠"],
            fontSizeName: 3.0, // vw
            fontSizeScore: 20.0, // vh
            scores: Array(GROUPS).fill(INITIAL_SCORE)
        };

        // Load Settings from LocalStorage
        let settings = JSON.parse(localStorage.getItem('groupScoreSettings')) || JSON.parse(JSON.stringify(DEFAULT_SETTINGS));

        // Ensure structure is correct (backward compatibility check)
        if (!settings.groupNames || settings.groupNames.length !== GROUPS) {
            settings.groupNames = DEFAULT_SETTINGS.groupNames;
        }
        if (!settings.scores) {
            settings.scores = Array(GROUPS).fill(INITIAL_SCORE);
        }

        // Apply loaded settings immediately
        document.documentElement.style.setProperty('--group-name-size', settings.fontSizeName + 'vw');
        document.documentElement.style.setProperty('--score-size', settings.fontSizeScore + 'vh');

        // History for Undo/Redo
        let history = [[...settings.scores]];
        let historyIndex = 0;

        // --- Render ---
        function render() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            settings.scores.forEach((score, index) => {
                const groupName = settings.groupNames[index];

                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${index}`;

                // Add click handler to toggle +1/-1 just as an alternative interaction
                // (Optional, user didn't ask but good for tablets)
                // card.onclick = () => updateScore(index, 1);

                card.innerHTML = `
                    <div class="group-name" onclick="resetScore(${index})" style="cursor: pointer;">${groupName}</div>
                    <div class="score" id="score-${index}">${score}</div>
                `;
                grid.appendChild(card);
            });
        }

        // Reset score to 0
        function resetScore(groupIndex) {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }

            const newScores = [...settings.scores];
            newScores[groupIndex] = 0;
            settings.scores = newScores;

            saveSettings();

            history.push([...settings.scores]);
            historyIndex++;

            render();
            triggerAnimation(groupIndex);
        }

        // --- Logic ---
        function updateScore(groupIndex, change) {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }

            const newScores = [...settings.scores];
            newScores[groupIndex] += change;
            settings.scores = newScores;

            // Save state
            saveSettings();

            history.push([...settings.scores]);
            historyIndex++;

            // Re-render only needed parts or full render? 
            // Full render is cheap here.
            render();
            triggerAnimation(groupIndex);
        }

        function triggerAnimation(index) {
            const scoreEl = document.getElementById(`score-${index}`);
            const cardEl = document.getElementById(`card-${index}`);

            if (cardEl) {
                cardEl.classList.add('active');
                setTimeout(() => cardEl.classList.remove('active'), 100);
            }

            if (scoreEl) {
                scoreEl.classList.remove('pop');
                void scoreEl.offsetWidth;
                scoreEl.classList.add('pop');
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                settings.scores = [...history[historyIndex]];
                saveSettings();
                render();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                settings.scores = [...history[historyIndex]];
                saveSettings();
                render();
            }
        }

        function saveSettings() {
            localStorage.setItem('groupScoreSettings', JSON.stringify(settings));
        }

        // --- Keyboard Controls ---
        const CONTROLS = {
            'q': { group: 0, action: 'up' }, 'a': { group: 0, action: 'down' },
            'w': { group: 1, action: 'up' }, 's': { group: 1, action: 'down' },
            'e': { group: 2, action: 'up' }, 'd': { group: 2, action: 'down' },
            'r': { group: 3, action: 'up' }, 'f': { group: 3, action: 'down' },
            't': { group: 4, action: 'up' }, 'g': { group: 4, action: 'down' }
        };

        window.addEventListener('keydown', (e) => {
            // Ignore keys if modal is open
            if (document.getElementById('settings-modal').style.display === 'block') return;

            const key = e.key.toLowerCase();

            if (e.ctrlKey) {
                if (key === 'z') { e.preventDefault(); undo(); return; }
                if (key === 'y') { e.preventDefault(); redo(); return; }
            }

            if (CONTROLS[key]) {
                const { group, action } = CONTROLS[key];
                if (action === 'up') updateScore(group, 1);
                else if (action === 'down') updateScore(group, -1);
            }
        });

        // --- Settings Menu Logic ---

        // Triple click detection
        let clickCount = 0;
        let clickTimer = null;
        const trigger = document.getElementById('settings-trigger');
        const modal = document.getElementById('settings-modal');
        const backdrop = document.getElementById('backdrop');

        function toggleModal() {
            const isVisible = modal.style.display === 'block';
            if (isVisible) {
                modal.style.display = 'none';
                backdrop.style.display = 'none';
                saveSettings(); // Ensure save on close
                render(); // Re-render in case names changed
            } else {
                initModalInputs();
                modal.style.display = 'block';
                backdrop.style.display = 'block';
            }
        }

        trigger.addEventListener('click', () => {
            clickCount++;
            if (clickCount === 1) {
                clickTimer = setTimeout(() => {
                    clickCount = 0;
                }, 800);
            } else if (clickCount === 3) {
                clearTimeout(clickTimer);
                clickCount = 0;
                toggleModal();
            }
        });

        // Also allow closing by clicking backdrop or close button
        backdrop.addEventListener('click', toggleModal);
        document.getElementById('close-settings').addEventListener('click', toggleModal);

        // Also support triple tap simulation if 'click' isn't responsive enough on touch
        trigger.addEventListener('touchstart', (e) => {
            // Browser usually translates tap to click, but just in case
        });

        // Init Modal Inputs
        const sizeNameSlider = document.getElementById('size-name');
        const sizeScoreSlider = document.getElementById('size-score');
        const nameInputsContainer = document.getElementById('name-inputs');

        function initModalInputs() {
            // Set slider values
            sizeNameSlider.value = settings.fontSizeName;
            sizeScoreSlider.value = settings.fontSizeScore;

            // Clear and fill name inputs
            nameInputsContainer.innerHTML = '';
            settings.groupNames.forEach((name, i) => {
                const div = document.createElement('div');
                div.className = 'name-input-item';
                div.innerHTML = `
                    <span>${i + 1}</span>
                    <input type="text" value="${name}" data-index="${i}">
                `;
                nameInputsContainer.appendChild(div);

                // Bind input change immediately
                const input = div.querySelector('input');
                input.addEventListener('input', (e) => {
                    settings.groupNames[i] = e.target.value;
                });
            });
        }

        // Live slider updates
        sizeNameSlider.addEventListener('input', (e) => {
            settings.fontSizeName = e.target.value;
            document.documentElement.style.setProperty('--group-name-size', settings.fontSizeName + 'vw');
        });

        sizeScoreSlider.addEventListener('input', (e) => {
            settings.fontSizeScore = e.target.value;
            document.documentElement.style.setProperty('--score-size', settings.fontSizeScore + 'vh');
        });

        // --- Init ---
        render();

    </script>
</body>

</html>
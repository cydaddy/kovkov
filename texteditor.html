<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Text Editor - Shortcut Enhanced</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root {
      --primary-color: #4f46e5;
      --bg-color: #f3f4f6;
      --text-color: #1f2937;
      --border-color: #e5e7eb;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-color);
      font-family: 'Noto Sans KR', sans-serif;
      color: var(--text-color);
    }

    #toolbar {
      flex: 0 0 auto;
      background-color: #ffffff;
      background-image: 
          linear-gradient(rgba(79, 70, 229, 0.05) 1px, transparent 1px),
          linear-gradient(90deg, rgba(79, 70, 229, 0.05) 1px, transparent 1px);
      background-size: 15px 15px;
      border-bottom: 1px solid #d1d5db;
      padding: 12px 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      box-shadow: var(--shadow);
      z-index: 100;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-right: 15px;
      border-right: 1px solid #d1d5db;
    }
    .control-group:last-child { border-right: none; }
    .control-group label {
      font-size: 0.8rem;
      font-weight: 700;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    input[type="range"] { width: 80px; cursor: pointer; accent-color: var(--primary-color); }
    input[type="number"] { width: 45px; padding: 3px; border: 1px solid var(--border-color); border-radius: 4px; text-align: center; }
    
    .color-wrapper {
      position: relative;
      width: 28px; height: 28px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--border-color);
      cursor: pointer;
    }
    input[type="color"] {
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      border: none; cursor: pointer;
    }

    .btn-group {
      display: flex;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 2px;
    }
    .icon-btn {
      background: transparent;
      border: none;
      padding: 5px 8px;
      border-radius: 6px;
      cursor: pointer;
      color: #6b7280;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .icon-btn:hover { background: rgba(79, 70, 229, 0.1); color: var(--primary-color); }
    .icon-btn.active { background: var(--primary-color); color: white; }

    /* 랜덤 버튼 스타일 */
    .random-btn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .random-btn:hover { background: #e5e7eb; }

    #editorContainer {
      flex: 1 1 auto;
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center; 
    }

    #editor {
      width: 100%; height: 100%;
      outline: none;
      border: none;
      padding: 20px;
      display: flex;
      flex-direction: column;
      word-wrap: break-word;
      white-space: pre-wrap;
      overflow: hidden; /* 스크롤바 절대 생성 방지 */
    }

    #toggleToolbarBtn {
      position: fixed;
      bottom: 20px; right: 20px;
      width: 45px; height: 45px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      z-index: 2000;
    }

  </style>
</head>
<body>

  <button id="toggleToolbarBtn" title="설정 토글 (F2)">
    <i class="ri-settings-3-fill"></i>
  </button>

  <div id="toolbar">
    <div class="control-group">
      <label><i class="ri-font-size"></i> 크기</label>
      <input type="range" id="fontSizeInput" value="40" min="10" max="300">
      <input type="number" id="fontSizeNumber" value="40" min="10" max="300">
      
      <div class="btn-group" style="margin-left: 5px;">
        <button id="boldBtn" class="icon-btn" title="굵게"><i class="ri-bold"></i></button>
      </div>
    </div>

    <div class="control-group">
      <label><i class="ri-palette-line"></i> 색상</label>
      <div class="color-wrapper" title="배경색">
        <input type="color" id="bgColorInput" value="#ffffff">
      </div>
      <div class="color-wrapper" title="글자색">
        <input type="color" id="textColorInput" value="#000000">
      </div>
      <button class="random-btn" id="randomColorBtn">
        <i class="ri-magic-line"></i> 랜덤 배색
      </button>
    </div>

    <div class="control-group">
      <label>정렬</label>
      <div class="btn-group" id="hAlignGroup">
        <button class="icon-btn" data-value="left"><i class="ri-align-left"></i></button>
        <button class="icon-btn" data-value="center"><i class="ri-align-center"></i></button>
        <button class="icon-btn" data-value="right"><i class="ri-align-right"></i></button>
      </div>
      <div class="btn-group" id="vAlignGroup">
        <button class="icon-btn" data-value="flex-start"><i class="ri-align-top"></i></button>
        <button class="icon-btn" data-value="center"><i class="ri-align-vertically"></i></button>
        <button class="icon-btn" data-value="flex-end"><i class="ri-align-bottom"></i></button>
      </div>
    </div>

    <div class="control-group" style="border:none;">
      <label>여백</label>
      <input type="range" id="marginInput" value="20" min="0" max="100">
    </div>
  </div>

  <div id="editorContainer">
    <div id="editor" contenteditable="true" spellcheck="false"></div>
  </div>

  <script>
    const storageKey = "personalTextEditorData_v2";
    
    const state = {
      fontSize: 40,
      bgColor: "#ffffff",
      textColor: "#000000",
      isBold: false,
      hAlign: "center",
      vAlign: "center",
      margin: 20
    };

    const els = {
      editor: document.getElementById('editor'),
      toolbar: document.getElementById('toolbar'),
      fontSizeRange: document.getElementById('fontSizeInput'),
      fontSizeNum: document.getElementById('fontSizeNumber'),
      bgInput: document.getElementById('bgColorInput'),
      textInput: document.getElementById('textColorInput'),
      boldBtn: document.getElementById('boldBtn'),
      hAlignBtns: document.querySelectorAll('#hAlignGroup .icon-btn'),
      vAlignBtns: document.querySelectorAll('#vAlignGroup .icon-btn'),
      marginRange: document.getElementById('marginInput'),
      randomBtn: document.getElementById('randomColorBtn'),
      toggleBtn: document.getElementById('toggleToolbarBtn')
    };

    function init() {
      loadData();
      renderUI();
      applyStyles();
      setupEventListeners();
      els.editor.focus();
    }

    // --- 핵심: 성능 최적화된 스타일 적용 (이진 탐색) ---
    function applyStyles() {
      const e = els.editor;
      
      // 기초 스타일 적용
      e.style.backgroundColor = state.bgColor;
      e.style.color = state.textColor;
      e.style.fontWeight = state.isBold ? '700' : '400';
      e.style.textAlign = state.hAlign;
      e.style.justifyContent = state.vAlign;
      e.style.padding = `${state.margin}px`;

      // 폰트 크기 최적화 찾기 (이진 탐색 알고리즘)
      let minSize = 1;
      let maxSize = state.fontSize; // 설정된 최대값부터 시작 (단축키로 늘리면 이 값이 늘어남)
      let optimalSize = minSize;

      // 브라우저 렌더링을 일시적으로 차단하고 계산
      e.style.visibility = 'hidden'; 

      while (minSize <= maxSize) {
        let mid = Math.floor((minSize + maxSize) / 2);
        e.style.fontSize = mid + 'px';

        // 내용이 화면보다 크면(스크롤 발생 시), 폰트를 줄여야 함
        if (e.scrollHeight <= e.clientHeight) {
          optimalSize = mid;
          minSize = mid + 1;
        } else {
          maxSize = mid - 1;
        }
      }

      // 최종 계산된 크기 적용 (스크롤이 안 생기는 최대 크기)
      e.style.fontSize = optimalSize + 'px';
      e.style.visibility = 'visible';
    }

    function setRandomColors() {
      const hue = Math.floor(Math.random() * 360);
      const bgL = 90;
      state.bgColor = hslToHex(hue, 30, bgL);
      const textL = 20;
      state.textColor = hslToHex(hue, 40, textL);
      
      renderUI();
      applyStyles();
      saveData();
    }

    function hslToHex(h, s, l) {
      l /= 100;
      const a = s * Math.min(l, 1 - l) / 100;
      const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');
      };
      return `#${f(0)}${f(8)}${f(4)}`;
    }

    function setupEventListeners() {
      // 입력 시 실시간 업데이트
      els.editor.addEventListener('input', () => {
        applyStyles();
        saveData();
      });

      // UI 컨트롤 이벤트 연결
      els.randomBtn.addEventListener('click', setRandomColors);

      els.fontSizeRange.addEventListener('input', (e) => {
        state.fontSize = parseInt(e.target.value);
        renderUI(); applyStyles(); saveData();
      });

      els.bgInput.addEventListener('input', (e) => {
        state.bgColor = e.target.value;
        applyStyles(); saveData();
      });

      els.textInput.addEventListener('input', (e) => {
        state.textColor = e.target.value;
        applyStyles(); saveData();
      });

      els.boldBtn.addEventListener('click', () => {
        state.isBold = !state.isBold;
        renderUI(); applyStyles(); saveData();
      });

      els.hAlignBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          state.hAlign = btn.dataset.value;
          renderUI(); applyStyles(); saveData();
        });
      });

      els.vAlignBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          state.vAlign = btn.dataset.value;
          renderUI(); applyStyles(); saveData();
        });
      });

      els.marginRange.addEventListener('input', (e) => {
        state.margin = parseInt(e.target.value);
        applyStyles(); saveData();
      });

      els.toggleBtn.addEventListener('click', () => {
        els.toolbar.style.display = els.toolbar.style.display === 'none' ? 'flex' : 'none';
      });

      window.addEventListener('resize', applyStyles);

      // --- 단축키 로직 ---
      window.addEventListener('keydown', (e) => {
        
        // F2: 툴바 토글
        if (e.key === 'F2') {
          e.preventDefault();
          els.toolbar.style.display = els.toolbar.style.display === 'none' ? 'flex' : 'none';
          return;
        }

        // 상태 일괄 업데이트용 헬퍼
        const updateState = () => {
          renderUI();
          applyStyles();
          saveData();
        };

        const isShift = e.shiftKey;
        const isCtrl = e.ctrlKey || e.metaKey; // Windows Ctrl 또는 Mac Command
        const isAlt = e.altKey;
        const key = e.code; // 키보드 위치 기준 코드값 (KeyE, KeyR ...)

        // 1. Shift + Alt + E : 글씨 커지게 (Max 설정 증가)
        if (isShift && isAlt && key === 'KeyE') {
          e.preventDefault();
          // 최대 300까지 10단위로 증가
          state.fontSize = Math.min(state.fontSize + 10, 300);
          updateState();
        }

        // 2. Shift + Alt + R : 글씨 작아지게
        if (isShift && isAlt && key === 'KeyR') {
          e.preventDefault();
          // 최소 10까지 10단위로 감소
          state.fontSize = Math.max(state.fontSize - 10, 10);
          updateState();
        }

        // 3. Ctrl + B : 글씨 굵게
        if (isCtrl && !isShift && !isAlt && key === 'KeyB') {
          e.preventDefault(); // 브라우저 기본 굵게 방지
          state.isBold = !state.isBold;
          updateState();
        }

        // 4. 가로 정렬 그룹
        // Shift + Ctrl + C : 가로 가운데
        if (isShift && isCtrl && !isAlt && key === 'KeyC') {
          e.preventDefault(); // 개발자도구 등 방지
          state.hAlign = 'center';
          updateState();
        }
        // Shift + Ctrl + L : 왼쪽 정렬
        if (isShift && isCtrl && !isAlt && key === 'KeyL') {
          e.preventDefault();
          state.hAlign = 'left';
          updateState();
        }
        // Shift + Ctrl + R : 오른쪽 정렬
        if (isShift && isCtrl && !isAlt && key === 'KeyR') {
          e.preventDefault(); // 강력 새로고침 방지
          state.hAlign = 'right';
          updateState();
        }

        // 5. 세로 정렬 그룹
        // Shift + Ctrl + Q : 위쪽 정렬
        if (isShift && isCtrl && !isAlt && key === 'KeyQ') {
          e.preventDefault();
          state.vAlign = 'flex-start';
          updateState();
        }
        // Shift + Ctrl + A : 세로 가운데
        if (isShift && isCtrl && !isAlt && key === 'KeyA') {
          e.preventDefault();
          state.vAlign = 'center';
          updateState();
        }
        // Shift + Ctrl + Z : 아래쪽 정렬
        if (isShift && isCtrl && !isAlt && key === 'KeyZ') {
          e.preventDefault();
          state.vAlign = 'flex-end';
          updateState();
        }
      });
    }

    function renderUI() {
      els.fontSizeRange.value = state.fontSize;
      els.fontSizeNum.value = state.fontSize;
      els.bgInput.value = state.bgColor;
      els.textInput.value = state.textColor;
      els.boldBtn.classList.toggle('active', state.isBold);
      els.hAlignBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.value === state.hAlign));
      els.vAlignBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.value === state.vAlign));
    }

    function loadData() {
      const stored = localStorage.getItem(storageKey);
      if (stored) {
        const data = JSON.parse(stored);
        if (data.content) els.editor.innerText = data.content;
        if (data.settings) Object.assign(state, data.settings);
      }
    }

    function saveData() {
      localStorage.setItem(storageKey, JSON.stringify({ content: els.editor.innerText, settings: state }));
    }

    init();
  </script>
</body>
</html>
